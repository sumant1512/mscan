<div class="product-form-container">
  <div class="page-header">
    <h1>{{ isEditMode ? 'Edit Product' : 'Add Product' }}</h1>
    <p class="subtitle">{{ isEditMode ? 'Update product information and attributes' : 'Create a new product with dynamic attributes' }}</p>
  </div>

  <!-- Alert Messages -->
  <div *ngIf="error" class="alert alert-error">
    <span class="icon">‚ö†Ô∏è</span>
    {{ error }}
  </div>

  <div *ngIf="success" class="alert alert-success">
    <span class="icon">‚úì</span>
    {{ success }}
  </div>

  <!-- Loading State -->
  <div *ngIf="loading && isEditMode" class="loading-container">
    <div class="spinner"></div>
    <p>Loading product...</p>
  </div>

  <!-- Product Form -->
  <form *ngIf="!loading || !isEditMode" [formGroup]="productForm" (ngSubmit)="onSubmit()">
    <!-- Basic Information Section -->
    <div class="form-section">
      <h2 class="section-title">Basic Information</h2>

      <div class="form-group">
        <label for="product_name" class="required">Product Name</label>
        <input
          type="text"
          id="product_name"
          formControlName="product_name"
          placeholder="Enter product name"
          class="form-input"
          [class.input-error]="isFieldInvalid('product_name')"
        />
        <span *ngIf="isFieldInvalid('product_name')" class="error-message">
          {{ getFieldError('product_name') }}
        </span>
      </div>

      <div class="form-group">
        <label for="verification_app_id" class="required">Verification App</label>
        <select
          id="verification_app_id"
          formControlName="verification_app_id"
          (change)="onAppChange()"
          class="form-input"
          [class.input-error]="isFieldInvalid('verification_app_id')"
        >
          <option value="">Select App</option>
          <option *ngFor="let app of availableApps" [value]="app.verification_app_id">
            {{ app.app_name }}
          </option>
        </select>
        <span *ngIf="isFieldInvalid('verification_app_id')" class="error-message">
          {{ getFieldError('verification_app_id') }}
        </span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="price">Price</label>
          <input
            type="number"
            id="price"
            formControlName="price"
            step="0.01"
            min="0"
            placeholder="0.00"
            class="form-input"
            [class.input-error]="isFieldInvalid('price')"
          />
          <span *ngIf="isFieldInvalid('price')" class="error-message">
            {{ getFieldError('price') }}
          </span>
        </div>

        <div class="form-group">
          <label for="currency">Currency</label>
          <select
            id="currency"
            formControlName="currency"
            class="form-input"
          >
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="INR">INR</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="image_url">Image URL</label>
        <input
          type="url"
          id="image_url"
          formControlName="image_url"
          placeholder="https://example.com/image.jpg"
          class="form-input"
        />
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="is_active" />
          <span>Active</span>
        </label>
      </div>
    </div>

    <!-- Template Info (Auto-selected from App) -->
    <div class="form-section" *ngIf="selectedTemplate">
      <h2 class="section-title">Product Template</h2>
      <div class="template-info-box">
        <div class="info-icon">üìã</div>
        <div class="info-content">
          <strong>{{ selectedTemplate.name }}</strong>
          <p class="small-text">Template automatically applied from verification app settings</p>
        </div>
      </div>
    </div>

    <!-- No Template Info -->
    <div class="form-section" *ngIf="!selectedTemplate && !isEditMode">
      <h2 class="section-title">Product Template</h2>
      <div class="info-message">
        <span class="info-icon">‚ÑπÔ∏è</span>
        <p>No template is assigned to this verification app. Products will use basic fields only.</p>
        <p class="small-text">To use structured product attributes, assign a product template to the verification app in the app settings.</p>
      </div>
    </div>

    <!-- Dynamic Attributes Section -->
    <div *ngIf="selectedTemplate && templateAttributes.length > 0" class="form-section attributes-section">
      <h2 class="section-title">Product Attributes****</h2>
      <p class="section-description">
        Template: <strong>{{ selectedTemplate.name }}</strong>
        <span class="badge">{{ templateAttributes.length }} attributes</span>
      </p>

      <div [formGroup]="attributesForm">
        <!-- Render attributes grouped by field_group -->
        <div *ngFor="let group of getAttributeGroups()" class="attribute-group">
          <h3 class="group-title">{{ group }}</h3>

          <div class="attributes-grid">
            <div *ngFor="let attribute of getAttributesInGroup(group)" class="form-group" [class.full-width]="isComplexType(attribute.data_type)">
              <!-- Complex Types: Variant List Editor -->
              <app-variant-list-editor
                *ngIf="isVariantListType(attribute.data_type)"
                [attribute]="attribute"
                [formControlName]="attribute.attribute_key"
              ></app-variant-list-editor>

              <!-- Complex Types: Structured Description Editor -->
              <app-structured-description-editor
                *ngIf="isStructuredListType(attribute.data_type)"
                [attribute]="attribute"
                [formControlName]="attribute.attribute_key"
              ></app-structured-description-editor>

              <!-- Simple Types -->
              <label
                *ngIf="!isComplexType(attribute.data_type)"
                [for]="'attr-' + attribute.attribute_key"
                [class.required]="attribute.is_required"
              >
                {{ attribute.attribute_name }}
              </label>

              <!-- Text/URL/Email Input -->
              <input
                *ngIf="isTextType(attribute.data_type) && !isComplexType(attribute.data_type)"
                [type]="getInputType(attribute.data_type)"
                [id]="'attr-' + attribute.attribute_key"
                [formControlName]="attribute.attribute_key"
                [placeholder]="attribute.placeholder || ''"
                class="form-input"
                [class.input-error]="isAttributeInvalid(attribute.attribute_key)"
              />

              <!-- Number Input -->
              <input
                *ngIf="isNumberType(attribute.data_type) && !isComplexType(attribute.data_type)"
                type="number"
                [id]="'attr-' + attribute.attribute_key"
                [formControlName]="attribute.attribute_key"
                [placeholder]="attribute.placeholder || ''"
                [min]="attribute.validation_rules?.min_value ?? null"
                [max]="attribute.validation_rules?.max_value ?? null"
                class="form-input"
                [class.input-error]="isAttributeInvalid(attribute.attribute_key)"
              />

              <!-- Date Input -->
              <input
                *ngIf="isDateType(attribute.data_type) && !isComplexType(attribute.data_type)"
                type="date"
                [id]="'attr-' + attribute.attribute_key"
                [formControlName]="attribute.attribute_key"
                class="form-input"
                [class.input-error]="isAttributeInvalid(attribute.attribute_key)"
              />

              <!-- Boolean Checkbox -->
              <label
                *ngIf="isBooleanType(attribute.data_type) && !isComplexType(attribute.data_type)"
                class="checkbox-label"
              >
                <input
                  type="checkbox"
                  [id]="'attr-' + attribute.attribute_key"
                  [formControlName]="attribute.attribute_key"
                />
                <span>{{ attribute.help_text || 'Yes' }}</span>
              </label>

              <!-- Select Dropdown -->
              <select
                *ngIf="isSelectType(attribute.data_type) && attribute.data_type === 'select' && !isComplexType(attribute.data_type)"
                [id]="'attr-' + attribute.attribute_key"
                [formControlName]="attribute.attribute_key"
                class="form-input"
                [class.input-error]="isAttributeInvalid(attribute.attribute_key)"
              >
                <option value="">Select {{ attribute.attribute_name }}</option>
                <option *ngFor="let option of getSelectOptions(attribute)" [value]="option">
                  {{ option }}
                </option>
              </select>

              <!-- Multi-Select (using multiple select for now) -->
              <select
                *ngIf="isSelectType(attribute.data_type) && attribute.data_type === 'multi-select' && !isComplexType(attribute.data_type)"
                [id]="'attr-' + attribute.attribute_key"
                [formControlName]="attribute.attribute_key"
                multiple
                size="3"
                class="form-input"
                [class.input-error]="isAttributeInvalid(attribute.attribute_key)"
              >
                <option *ngFor="let option of getSelectOptions(attribute)" [value]="option">
                  {{ option }}
                </option>
              </select>

              <!-- Help Text -->
              <small *ngIf="attribute.help_text && !isBooleanType(attribute.data_type) && !isComplexType(attribute.data_type)" class="form-hint">
                {{ attribute.help_text }}
              </small>

              <!-- Error Message -->
              <span *ngIf="isAttributeInvalid(attribute.attribute_key) && !isComplexType(attribute.data_type)" class="error-message">
                {{ getAttributeError(attribute) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button" class="btn btn-outline" (click)="cancel()" [disabled]="loading">
        Cancel
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="loading">
        <span *ngIf="!loading">{{ isEditMode ? 'Update Product' : 'Create Product' }}</span>
        <span *ngIf="loading">Processing...</span>
      </button>
    </div>
  </form>
</div>
