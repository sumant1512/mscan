<div class="create-container">
  <div class="header">
    <h2>Create New Coupon</h2>
    <div class="balance-indicator">
      <span class="balance-label">Available Credits:</span>
      <span class="balance-value">{{ currentBalance }}</span>
    </div>
  </div>

  <div *ngIf="verificationApps.length === 0 && !loading" class="alert alert-warning">
    ‚ö†Ô∏è No active verification apps found. Please configure a verification app before creating
    coupons.
  </div>

  <div *ngIf="error" class="alert alert-error">{{ error }}</div>
  <div *ngIf="success" class="alert alert-success">{{ success }}</div>

  <!-- Batch Results Display -->
  <div *ngIf="showBatchResults" class="batch-results">
    <h3>Generated Coupons ({{ generatedCoupons.length }})</h3>
    <div class="batch-actions">
      <button type="button" (click)="downloadCouponsCSV()" class="btn-secondary">
        üì• Download CSV
      </button>
      <button type="button" (click)="closeAndNavigate()" class="btn-primary">
        View All Coupons
      </button>
    </div>
    <div class="coupon-list">
      <div *ngFor="let coupon of generatedCoupons" class="coupon-item">
        <span class="coupon-code">{{ coupon.coupon_code }}</span>
        <button type="button" (click)="copyCouponCode(coupon.coupon_code)" class="btn-copy">
          üìã Copy
        </button>
      </div>
    </div>
  </div>

  <form
    [formGroup]="couponForm"
    (ngSubmit)="onSubmit()"
    class="coupon-form"
    *ngIf="!showBatchResults"
  >
    <div class="form-sections">
      <!-- Left Column -->
      <div class="form-section">
        <h3>Basic Information</h3>

        <div class="form-group">
          <label for="verification_app_id">Verification App <span class="required">*</span></label>
          <select
            id="verification_app_id"
            formControlName="verification_app_id"
            [class.invalid]="isFieldInvalid('verification_app_id')"
          >
            <option value="">Select an app</option>
            <option *ngFor="let app of verificationApps" [value]="app.id">
              {{ app.app_name }}
            </option>
          </select>
          <span *ngIf="isFieldInvalid('verification_app_id')" class="error-text">
            {{ getFieldError('verification_app_id') }}
          </span>
        </div>

        <div class="form-group">
          <label for="description">Coupon Description <span class="required">*</span></label>
          <input
            type="text"
            id="description"
            formControlName="description"
            [class.invalid]="isFieldInvalid('description')"
            placeholder="e.g., Summer Sale 2024"
          />
          <span *ngIf="isFieldInvalid('description')" class="error-text">
            {{ getFieldError('description') }}
          </span>
        </div>

        <div class="form-group">
          <label for="discount_value">
            Discount Amount (Fixed) <span class="required">*</span>
          </label>
          <input
            type="number"
            id="discount_value"
            formControlName="discount_value"
            [class.invalid]="isFieldInvalid('discount_value')"
            placeholder="e.g., 10"
            min="1"
            step="0.01"
          />
          <small class="hint">Enter fixed discount amount per coupon</small>
          <span *ngIf="isFieldInvalid('discount_value')" class="error-text">
            {{ getFieldError('discount_value') }}
          </span>
        </div>
      </div>

      <!-- Right Column -->
      <div class="form-section">
        <h3>Validity & Usage</h3>

        <div class="form-group">
          <label for="expiry_date">Expiry Date <span class="required">*</span></label>
          <input
            type="datetime-local"
            id="expiry_date"
            formControlName="expiry_date"
            [class.invalid]="isFieldInvalid('expiry_date')"
          />
          <span *ngIf="isFieldInvalid('expiry_date')" class="error-text">
            {{ getFieldError('expiry_date') }}
          </span>
        </div>

        <div class="form-group">
          <label for="quantity">Number of Coupons <span class="required">*</span></label>
          <input
            type="number"
            id="quantity"
            formControlName="quantity"
            [class.invalid]="isFieldInvalid('quantity')"
            placeholder="e.g., 50"
            min="1"
            max="500"
          />
          <small class="hint"
            >Generate 1 to 500 unique coupon codes. Each code can be scanned once.</small
          >
          <span *ngIf="isFieldInvalid('quantity')" class="error-text">
            {{ getFieldError('quantity') }}
          </span>
        </div>
      </div>
    </div>

    <!-- Cost Estimate -->
    <div class="cost-estimate">
      <div class="cost-label">Estimated Credit Cost:</div>
      <div class="cost-value">{{ estimatedCost }}</div>
      <div class="cost-note">
        {{ couponForm.value.quantity || 0 }} coupon(s) √ó ${{
          couponForm.value.discount_value || 0
        }}
        = {{ estimatedCost }} credits
      </div>
      <div *ngIf="estimatedCost > currentBalance" class="cost-warning">
        ‚ö†Ô∏è Insufficient credits! Need {{ estimatedCost - currentBalance }} more credits.
      </div>
    </div>

    <!-- Actions -->
    <div class="form-actions">
      <button type="button" (click)="cancel()" class="btn-secondary" [disabled]="loading">
        Cancel
      </button>
      <button
        type="submit"
        class="btn-primary"
        [disabled]="loading || couponForm.invalid || estimatedCost > currentBalance"
      >
        {{
          loading
            ? 'Creating...'
            : couponForm.value.coupon_generation_type === 'BATCH'
            ? 'Generate Coupons'
            : 'Create Coupon'
        }}
      </button>
    </div>
  </form>
</div>
