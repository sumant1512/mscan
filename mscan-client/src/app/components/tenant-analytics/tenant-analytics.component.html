<div class="analytics-container">
  <div class="header">
    <h2>Analytics Dashboard</h2>
    <div class="actions">
      <button class="btn btn-primary" (click)="createBatch()">
        <i class="icon">+</i> Create Batch
      </button>
    </div>
  </div>

  <!-- Time Filter -->
  <div class="time-filter">
    <button
      class="filter-btn"
      [class.active]="timeFilter() === '7d'"
      (click)="changeTimeFilter('7d')"
    >
      Last 7 Days
    </button>
    <button
      class="filter-btn"
      [class.active]="timeFilter() === '30d'"
      (click)="changeTimeFilter('30d')"
    >
      Last 30 Days
    </button>
    <button
      class="filter-btn"
      [class.active]="timeFilter() === '90d'"
      (click)="changeTimeFilter('90d')"
    >
      Last 90 Days
    </button>
    <button
      class="filter-btn"
      [class.active]="timeFilter() === 'all'"
      (click)="changeTimeFilter('all')"
    >
      All Time
    </button>
  </div>

  @if (error()) {
    <div class="alert alert-error">{{ error() }}</div>
  }

  @if (loading()) {
    <div class="loading">Loading analytics...</div>
  } @else {
    <!-- Overview Cards -->
    <div class="overview-section">
      <h3>Overview</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon scans">ðŸ“Š</div>
          <div class="stat-content">
            <div class="stat-value">{{ overviewStats().total_scans }}</div>
            <div class="stat-label">Total Scans</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon users">ðŸ‘¥</div>
          <div class="stat-content">
            <div class="stat-value">{{ overviewStats().unique_users }}</div>
            <div class="stat-label">Unique Users</div>
            <div class="stat-detail">
              {{ getUniqueUserPercentage() }}% of total scans
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon repeat">ðŸ”„</div>
          <div class="stat-content">
            <div class="stat-value">{{ overviewStats().repeat_users }}</div>
            <div class="stat-label">Repeat Users</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon coupons">ðŸŽ«</div>
          <div class="stat-content">
            <div class="stat-value">{{ overviewStats().active_coupons }}</div>
            <div class="stat-label">Active Coupons</div>
            <div class="stat-detail">
              {{ overviewStats().total_coupons }} total
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon redeemed">âœ…</div>
          <div class="stat-content">
            <div class="stat-value">{{ overviewStats().redeemed_coupons }}</div>
            <div class="stat-label">Redeemed</div>
            <div class="stat-detail">
              {{ getRedemptionRate() }}% redemption rate
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon reward">ðŸ’°</div>
          <div class="stat-content">
            <div class="stat-value">â‚¹{{ overviewStats().total_reward_value }}</div>
            <div class="stat-label">Total Rewards</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scan Trends -->
    <div class="trends-section">
      <h3>Scan Trends</h3>
      @if (scanTrends().length > 0) {
        <div class="chart-container">
          <div class="chart">
            @for (trend of scanTrends(); track trend.date) {
              <div class="chart-bar-container">
                <div
                  class="chart-bar"
                  [style.height.%]="(trend.count / (scanTrends()[0]?.count || 1)) * 100"
                  [title]="trend.count + ' scans'"
                ></div>
                <div class="chart-label">{{ trend.date | date: 'MMM d' }}</div>
              </div>
            }
          </div>
        </div>
      } @else {
        <p class="empty-state">No scan data available for the selected period.</p>
      }
    </div>

    <!-- Top Cities -->
    <div class="cities-section">
      <h3>Top 10 Cities by Scans</h3>
      @if (topCities().length > 0) {
        <div class="cities-list">
          @for (city of topCities(); track city.city) {
            <div class="city-item">
              <div class="city-info">
                <span class="city-name">{{ city.city }}</span>
                <span class="city-scans">{{ city.scans }} scans</span>
              </div>
              <div class="city-bar-container">
                <div
                  class="city-bar"
                  [style.width.%]="city.percentage"
                ></div>
                <span class="city-percentage">{{ city.percentage }}%</span>
              </div>
            </div>
          }
        </div>
      } @else {
        <p class="empty-state">No city data available.</p>
      }
    </div>

    <!-- Batch Performance -->
    <div class="batch-section">
      <div class="section-header">
        <h3>Batch Performance</h3>
        <button class="btn btn-sm btn-secondary" (click)="viewScanHistory()">
          View All Batches
        </button>
      </div>
      @if (batchStats().length > 0) {
        <table class="batch-table">
          <thead>
            <tr>
              <th>Dealer Name</th>
              <th>Zone</th>
              <th>Total Coupons</th>
              <th>Scanned</th>
              <th>Redemption Rate</th>
            </tr>
          </thead>
          <tbody>
            @for (batch of batchStats(); track batch.batch_id) {
              <tr>
                <td>{{ batch.dealer_name }}</td>
                <td><span class="zone-badge">{{ batch.zone }}</span></td>
                <td>{{ batch.total_coupons }}</td>
                <td>{{ batch.scanned_coupons }}</td>
                <td>
                  <div class="progress-bar-container">
                    <div
                      class="progress-bar"
                      [style.width.%]="batch.redemption_rate"
                      [class.high]="batch.redemption_rate >= 70"
                      [class.medium]="batch.redemption_rate >= 40 && batch.redemption_rate < 70"
                      [class.low]="batch.redemption_rate < 40"
                    ></div>
                    <span class="progress-label">{{ batch.redemption_rate }}%</span>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      } @else {
        <p class="empty-state">No batch data available.</p>
      }
    </div>
  }
</div>
