<div class="form-container">
  <div class="form-header">
    <h2>{{ isEditMode ? 'Edit User' : 'Create New User' }}</h2>
  </div>

  <div *ngIf="error" class="alert alert-error">{{ error }}</div>

  <div *ngIf="loading$ | async" class="loading">
    <p>Loading user data...</p>
  </div>

  <form *ngIf="!(loading$ | async)" (ngSubmit)="onSubmit()" class="user-form">
    <!-- Basic Information Section -->
    <div class="form-section">
      <h3>Basic Information</h3>

      <div class="form-group">
        <label for="full_name">Full Name <span class="required">*</span></label>
        <input
          id="full_name"
          type="text"
          [(ngModel)]="formData.full_name"
          name="full_name"
          placeholder="Enter full name"
          required
        />
      </div>

      <div class="form-group">
        <label for="email">Email <span class="required">*</span></label>
        <input
          id="email"
          type="email"
          [(ngModel)]="formData.email"
          name="email"
          placeholder="user@example.com"
          [readonly]="isEditMode"
          required
        />
        <small *ngIf="isEditMode" class="help-text">Email cannot be changed after creation</small>
      </div>

      <div class="form-group">
        <label for="phone">Phone</label>
        <input
          id="phone"
          type="tel"
          [(ngModel)]="formData.phone"
          name="phone"
          placeholder="+1 (555) 123-4567"
        />
      </div>

      <div class="form-group">
        <label for="role">Role <span class="required">*</span></label>
        <select
          id="role"
          [(ngModel)]="formData.role"
          name="role"
          required
        >
          <option value="TENANT_USER">Tenant User</option>
          <option value="TENANT_ADMIN">Tenant Admin</option>
        </select>
        <small class="help-text">
          Tenant Admins can manage users and have elevated permissions
        </small>
      </div>
    </div>

    <!-- Permissions Section -->
    <div class="form-section">
      <h3>Permissions</h3>
      <p class="section-description">
        Assign specific permissions to this user. Permissions control what actions the user can perform in the system.
      </p>

      <div *ngIf="loadingPermissions" class="loading-permissions">
        Loading available permissions...
      </div>

      <div *ngIf="!loadingPermissions && availablePermissions.length === 0" class="no-permissions">
        No permissions available to assign
      </div>

      <div *ngIf="!loadingPermissions && availablePermissions.length > 0" class="permissions-grid">
        <!-- TENANT Scope Permissions -->
        <div *ngIf="getPermissionsByScope('TENANT').length > 0" class="permission-group">
          <h4>Tenant Permissions</h4>
          <div class="permission-checkboxes">
            <div
              *ngFor="let permission of getPermissionsByScope('TENANT')"
              class="permission-item"
            >
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="isPermissionSelected(permission.id)"
                  (change)="togglePermission(permission.id)"
                />
                <div class="permission-info">
                  <span class="permission-name">{{ permission.name }}</span>
                  <span class="permission-code">{{ permission.code }}</span>
                  <span *ngIf="permission.description" class="permission-description">
                    {{ permission.description }}
                  </span>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- USER Scope Permissions -->
        <div *ngIf="getPermissionsByScope('USER').length > 0" class="permission-group">
          <h4>User Permissions</h4>
          <div class="permission-checkboxes">
            <div
              *ngFor="let permission of getPermissionsByScope('USER')"
              class="permission-item"
            >
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="isPermissionSelected(permission.id)"
                  (change)="togglePermission(permission.id)"
                />
                <div class="permission-info">
                  <span class="permission-name">{{ permission.name }}</span>
                  <span class="permission-code">{{ permission.code }}</span>
                  <span *ngIf="permission.description" class="permission-description">
                    {{ permission.description }}
                  </span>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- GLOBAL Scope Permissions (if any) -->
        <div *ngIf="getPermissionsByScope('GLOBAL').length > 0" class="permission-group">
          <h4>Global Permissions</h4>
          <div class="permission-checkboxes">
            <div
              *ngFor="let permission of getPermissionsByScope('GLOBAL')"
              class="permission-item"
            >
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="isPermissionSelected(permission.id)"
                  (change)="togglePermission(permission.id)"
                />
                <div class="permission-info">
                  <span class="permission-name">{{ permission.name }}</span>
                  <span class="permission-code">{{ permission.code }}</span>
                  <span *ngIf="permission.description" class="permission-description">
                    {{ permission.description }}
                  </span>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="selected-permissions-summary">
        <strong>{{ selectedPermissionIds.length }}</strong> permission(s) selected
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button" (click)="cancel()" class="btn-secondary" [disabled]="saving">
        Cancel
      </button>
      <button type="submit" class="btn-primary" [disabled]="saving">
        <span *ngIf="!saving">{{ isEditMode ? 'Update User' : 'Create User' }}</span>
        <span *ngIf="saving">{{ isEditMode ? 'Updating...' : 'Creating...' }}</span>
      </button>
    </div>
  </form>
</div>
